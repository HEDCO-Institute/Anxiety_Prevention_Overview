---
title: "Descriptive Results"
author: "Shaina Trevino"
date: "2024-02-20"
output: html_document
---

```{r setup, include=FALSE}
#set up that would go in front sections of bookdown technical report
knitr::opts_chunk$set(echo = FALSE, include = FALSE)

#install and load pacman package
if (!require("pacman")) install.packages("pacman")

#install and load required packages
p_load(devtools, rio, here, readxl, janitor, tidyverse, openxlsx, lubridate, gt, webshot2) #, robumeta, metafor,  DiagrammeR, prismadiagramR, stringi, htmltools, bib2df
p_load_gh("thdiakon/ccaR", "mcguinlu/robvis") #from github

```

```{r import}
#import code chunk goes in front sections of bookdown technical report
#review eligibility
review_elig_df <- import(here("data", "APO_review_eligibility.xlsx"))

#study eligibility (no linked refs)
study_elig_df <- import(here("data", "APO_study_eligibility.xlsx")) %>% 
  janitor::clean_names()

#review level and rob
review_df <- import(here("data", "APO_review_data_collection.xlsx")) %>% 
  janitor::clean_names()

#study citation matrix
#set path to eligibility data
elig_path <- here("data", "Anxiety_Overview_Eligibility_Data.xlsx")

#import excel primary study reference sheet
#ps_allreferences <- read_excel(elig_path, sheet = "reports") 

#import excel citation matrix (with header to calculate # of included/eligible studies)
ps_cm <- read_excel(elig_path, sheet = "citation_matrix")

#import excel citation matrix sheet (without header to transpose for lists of included/eligible reviews)
citation_matrix <- read_excel(elig_path, sheet = "citation_matrix", col_names = FALSE)

#study level
study_df <- import(here("data", "APO_study_level.xlsx")) %>% 
  janitor::clean_names()

#ROB_level
study_rob_df <- import(here("data", "APO_study_ROB.xlsx"))%>% 
  janitor::clean_names()

#group_level
group_df <- import(here("data", "APO_group_level.xlsx"))%>% 
  janitor::clean_names()

#outcome_level
outcome_df <- import(here("data", "APO_outcome_level.xlsx"))%>% 
  janitor::clean_names()

#effect_level
effect_df <- import(here("data", "APO_effect_level.csv"))%>% 
  janitor::clean_names()

#merge with outcomes for Maria
# maria_es <- outcome_df %>% 
#   distinct(across(-user), .keep_all = TRUE) %>% 
#   select(refid, outcomes_k, study_outcome_type, study_outcome_domain) %>%
#   rename(effect_outcome = outcomes_k) %>% 
#   right_join(effect_df, by = c("refid", "effect_outcome")) #%>% #792
#   #distinct(across(-user), .keep_all = TRUE) #396
# 
# export(maria_es, "APO_effect_outcome_merged.xlsx")

# #CHECK
# length(unique(maria_es$study_es_list_k)) #388 - should be 396 meaning some keys are repeated - check if repeated across refids
# check <- maria_es %>% 
#   distinct(study_es_list_k, refid) #396 - so keys are repeated across refids

```

```{r tidy}
#study level
inc_ps_wlinked <- study_elig_df %>% 
  filter(study_eligibility_decision == "Eligible") %>% 
  pull(refid)

inc_ps <- study_df %>% 
  pull(refid)

study_td <- study_df %>% 
  rowwise() %>%
  mutate(study_grade_level = paste(na.omit(c_across(starts_with("study_grade_level_"))), collapse = "; "),
         study_school_level = paste(na.omit(c_across(starts_with("study_school_level_"))), collapse = "; "),
         study_country = paste(na.omit(c_across(starts_with("study_country_"))), collapse = "; "),
         study_school_area = paste(na.omit(c_across(starts_with("study_school_area_"))), collapse = "; "),
         study_school_type = paste(na.omit(c_across(starts_with("study_school_type_"))), collapse = "; "),
         study_state = paste(na.omit(c_across(starts_with("study_state_"))), collapse = "; "),
         study_school_level = ifelse(study_school_level == "High School; Only reported Secondary School", "High School", study_school_level),) %>%
  mutate(across(where(is.character), ~str_replace_all(., "; Cannot tell", ""))) %>% 
  ungroup() %>% 
  mutate(across(c(study_cluster_size, starts_with("study_percent"), starts_with("study_number"),
                  study_age_average, study_publication_year), ~ as.numeric(replace(., . == -999, NA))))

group_td <- group_df %>% 
  distinct(across(-user), .keep_all = TRUE) %>% 
  rowwise() %>% 
  mutate(study_group_format = paste(na.omit(c_across(starts_with("study_group_format_"))), collapse = "; "),
         study_group_provider = paste(na.omit(c_across(starts_with("study_group_provider_"))), collapse = "; "),
         study_group_recipients = paste(na.omit(c_across(starts_with("study_group_recipients_"))), collapse = "; "),
         study_group_location = paste(na.omit(c_across(starts_with("study_group_location_"))), collapse = "; "),
         study_group_mode = paste(na.omit(c_across(starts_with("study_group_mode_"))), collapse = "; "),
         study_group_recipients = paste(na.omit(c_across(starts_with("study_group_recipients_"))), collapse = "; "),
         study_group_name = case_when(study_group_type == "Intervention" ~ study_intervention_name,
                                      study_group_comparison_type == "Active" ~ paste0("Active: ", study_comparison_name),
                                      TRUE ~ as.character(study_group_comparison_type))) %>% 
  ungroup() %>% 
  mutate(across(where(is.character), ~str_replace_all(., "; Cannot tell", "")),
         study_group_intensity = ifelse(str_detect(study_group_intensity, "-") & study_group_intensity != "-999",
                                        str_extract(study_group_intensity, "(?<=-).*"),
                                        study_group_intensity)) %>% 
  mutate(across(c(study_group_duration, study_group_sessions, study_group_intensity), ~ifelse(. == "-999", NA, as.numeric(.)))) 

outcome_td <- outcome_df %>% 
  distinct(across(-user), .keep_all = TRUE)

irob_td <- study_rob_df %>% 
  select(refid, starts_with("irob")) %>% 
  filter(rowSums(!is.na(select(., -refid))) > 0) %>% 
  select(refid, ends_with("rating"), ends_with("judgment"), ends_with("decision"))
  
crob_td <- study_rob_df %>% 
  select(refid, starts_with("crob")) %>% 
  filter(rowSums(!is.na(select(., -refid))) > 0) %>% 
  select(refid, ends_with("rating"), ends_with("judgment"), ends_with("decision"))

robins_td <- study_rob_df %>% 
  select(refid, starts_with("robins")) %>% 
  filter(rowSums(!is.na(select(., -refid))) > 0) %>% 
  select(refid, ends_with("rating"), ends_with("judgment"), ends_with("decision"))
  
#review level
review_td <- review_df %>% 
  select(-starts_with("amstar"), -starts_with("robis")) %>% 
  mutate(review_publication_year = as.numeric(review_publication_year),
         review_author_year = ifelse(refid == 2734, "Hugh-Jones 2021",
                                     review_author_year))

amstar_rating_td <- review_df %>% 
  select(refid, review_author_year, starts_with("amstar")) %>% 
  select(refid, review_author_year, ends_with("rating"))

robis_rating_td <- review_df %>% 
  select(refid, review_author_year, starts_with("robis")) %>% 
  select(refid, review_author_year, ends_with("decision"), robis_overall_a, robis_overall_b, robis_overall_c, 
         robis_overall_rating)

```

```{r functions}
#Write functions for formatting inline code
format_thousands <- function(x) {
  big_num <- format(x, big.mark = ",")
  return(big_num)
}

format_percent <- function(x, digits, force_decimal = FALSE) {
  if (force_decimal) {
    percentage <- paste0(format(round(x, digits), nsmall = digits), "%")
  } else {
    percentage <- paste0(round(x, digits), "%")
  }
  return(percentage)
}
```



# Results

```{r exclude_reasons}
summary(as.factor(review_elig_df$review_exclude_reason))

summary(as.factor(study_elig_df$study_exclude_reason))
```

## Characteristics of Included Systematic Reviews

```{r review-char}
#Calculate most commonly searched databases
#change string to lowercase and create flag if each database was searched
rev_df <- review_td %>% 
  mutate(review_databases_searched = str_to_lower(review_databases_searched),
         pubmed = str_detect(review_databases_searched, "pubmed"),
         psycinfo = str_detect(review_databases_searched, "psycinfo"),
         medline = str_detect(review_databases_searched, "medline|ovid"),
         eric = str_detect(review_databases_searched, "eric|education resources information center"),
         ebsco = str_detect(review_databases_searched, "ebsco"),
         proquest_dt = str_detect(review_databases_searched, "dissertation and theses"),
         psycarticles = str_detect(review_databases_searched, "psycarticles"),
         psycextra = str_detect(review_databases_searched, "psycextra|psychextra"),
         cochrance_central = str_detect(review_databases_searched, "cochrane central"),
         cochrane_library = str_detect(review_databases_searched, "cochrane library"),
         wos = str_detect(review_databases_searched, "web of science"),
         academic_ap = str_detect(review_databases_searched, "academic search premier"),
         pbs_collection = str_detect(review_databases_searched, "psychology and behavioral sciences collection"),
         cinahl = str_detect(review_databases_searched, "cinahl"),
         embase = str_detect(review_databases_searched, "embase"),
         science_cit_index = str_detect(review_databases_searched, "science citation index"),
         sci_direct = str_detect(review_databases_searched, "science direct|sciencedirect"),
         scopus = str_detect(review_databases_searched, "scopus"),
         gscholar = str_detect(review_databases_searched, "google scholar|googlescholar"),
         british_ni = str_detect(review_databases_searched, "british nursing index"),
         britich_ei = str_detect(review_databases_searched, "british education index"),
         assia = str_detect(review_databases_searched, "assia"),
         diss_abs = str_detect(review_databases_searched, "dissertation abstracts"),
         socio_abs = str_detect(review_databases_searched, "sociological abstracts"),
         won = str_detect(review_databases_searched, "web of knowledge"),
         ctg = str_detect(review_databases_searched, "clinicaltrials.gov"),
         prosp = str_detect(review_databases_searched, "prospero"),
         epist = str_detect(review_databases_searched, "epistemonikos"))

#create long dataframe
review_databases <- rev_df %>% 
  select(refid, pubmed:epist) %>% 
  pivot_longer(cols = pubmed:epist) %>% 
  mutate(value = as.character(value))

#calculate most common databases searched and 
#remove cases where reviews said both pubmed and medline but only searched one
mode_databases <- review_databases %>% 
  group_by(name) %>% 
  summarize(num_db = sum(value == "TRUE"),
            percent = sum(value == "TRUE") / nrow(review_df) * 100) %>% 
  arrange(desc(num_db))

#Year of last database search
#extract review year from search data
review_df <- review_df %>% 
  mutate(db_search_year = as.numeric(str_extract(review_search_date, "[0-9]{4}")))

#Transparency
#number of reviews with flow diagrams
num_prisma <- sum(review_df$review_flow_diagram == "Yes", na.rm = TRUE) 

#number of reviews with registration number
num_reg <- sum(review_df$review_registration_number != "-999") 

#number of reviews with availability statements
num_avail <- sum(review_df$review_availability_statement != "-999")


```


Overall, these `r nrow(review_td)` reviews were published between `r min(review_td$review_publication_year)` and `r max(review_td$review_publication_year)`, with a median publication year of `r median(review_td$review_publication_year)` (see *Table 1*). These reviews most commonly searched APA PsycInfo (`r mode_databases$num_db[1]` reviews; `r format_percent(mode_databases$percent[1], 1)`), MEDLINE (`r mode_databases$num_db[2]` reviews; `r format_percent(mode_databases$percent[2], 1)`), ERIC (`r mode_databases$num_db[3]` reviews; `r format_percent(mode_databases$percent[3], 1)`), Google Scholar (`r mode_databases$num_db[4]` reviews; `r format_percent(mode_databases$percent[4], 1)`), and PubMed (`r mode_databases$num_db[5]` reviews; `r format_percent(mode_databases$percent[5], 1)`) to identify primary studies. The year that each review last conducted their literature search ranged from `r min(review_df$db_search_year, na.rm = TRUE)` to `r max(review_df$db_search_year, na.rm = TRUE)`, with a median of `r ceiling(median(review_df$db_search_year, na.rm = TRUE))`. Regarding research transparency, `r num_prisma` reviews (`r format_percent(num_prisma / nrow(review_df) * 100, 1)`) included a flow diagram of information through the different phases of a systematic review (Page et al., 2021), `r num_reg` reviews (`r format_percent(num_reg / nrow(review_df) * 100, 1)`) reported a registration number for their review (Booth et al., 2012), and `r num_avail` reviews (`r format_percent(num_avail / nrow(review_df) *100, 1)`) provided statements about the data and code underlying the review (Page et al., 2022). 

### Methodological Quality and Risk of Bias of Included Systematic Reviews

```{r rob-inline}
#number/% of high confidence
amstar_high <- sum(amstar_rating_td$amstar_overall_rating == "HIGH") 
amstar_high_per <- amstar_high  / nrow(amstar_rating_td) * 100 

#number/% of moderate confidence
amstar_mod <- sum(amstar_rating_td$amstar_overall_rating == "MODERATE")
amstar_mod_per <- amstar_mod  / nrow(amstar_rating_td) * 100 

#number/% of low confidence
amstar_low <- sum(amstar_rating_td$amstar_overall_rating == "LOW")
amstar_low_per <- amstar_low  / nrow(amstar_rating_td) * 100 

#number/% of critically low confidence
amstar_clow <- sum(amstar_rating_td$amstar_overall_rating == "CRITICALLY LOW")
amstar_clow_per <- amstar_clow  / nrow(amstar_rating_td) * 100 

#Calculate most common critical weaknesses in AMSTAR ratings among reviews
#filter for critical domains
amstar_crit <- amstar_rating_td %>% 
  select(refid, amstar_2_rating, amstar_4_rating, amstar_7_rating, amstar_9rct_rating, amstar_9nrsi_rating,
         amstar_11rct_rating, amstar_11rct_rating, amstar_13_rating, amstar_15_rating) %>% 
  pivot_longer(cols = -refid)

#calculate frequency for "No"s per critical domains
amstar_crit_mode <- amstar_crit %>% 
  group_by(name) %>% 
  summarize(n = sum(value == "No"),
            percent = sum(value == "No") / nrow(amstar_rating_td) * 100) %>% 
  arrange(desc(n))

#Calculate most common non-critical weaknesses in AMSTAR ratings among reviews
#filter for non-critical domains
amstar_noncrit <- amstar_rating_td %>% 
  select(refid, amstar_1_rating, amstar_3_rating, amstar_5_rating, amstar_6_rating, amstar_8_rating, 
         amstar_10_rating, amstar_12_rating, amstar_14_rating, amstar_16_rating) %>% 
  pivot_longer(cols = -refid)

#calculate frequency for "No"s per non-critical domains
amstar_noncrit_mode <- amstar_noncrit %>% 
  group_by(name) %>% 
  summarize(n = sum(value == "No"),
            percent = sum(value == "No") / nrow(amstar_rating_td) * 100) %>% 
  arrange(desc(n))

#ROBIS results
#number/% of low risk
robis_low <- sum(robis_rating_td$robis_overall_rating == "LOW")
robis_low_per <- robis_low  / nrow(robis_rating_td) * 100 

#number/% of unclear risk
robis_unclear <- sum(robis_rating_td$robis_overall_rating == "UNCLEAR") 
robis_unclear_per <- robis_unclear  / nrow(robis_rating_td) * 100 

#number/% of high risk
robis_high <- sum(robis_rating_td$robis_overall_rating == "HIGH") 
robis_high_per <- robis_high  / nrow(robis_rating_td) * 100 

#select ratings, transform to long format, calculate percent with high risk
robis_concerns <- robis_rating_td %>% 
  select(refid, ends_with("decision"), robis_overall_a, 
         robis_overall_b, robis_overall_c) %>% 
  pivot_longer(cols = 2:8) %>% 
  group_by(name) %>% 
  summarize(n_decision = sum(value == "HIGH"),
            per_decision = sum(value == "HIGH") / nrow(robis_rating_td) * 100,
            n_overall = sum(value == "No"),
            per_overall = sum(value == "No") / nrow(robis_rating_td) * 100) %>% 
  arrange(desc(n_decision))


```


AMSTAR-2 assessments (see *Table 2*) yielded methodological quality ratings of low for `r amstar_low` reviews (`r format_percent(amstar_low_per, 1)`) and critically low for `r amstar_clow` reviews (`r format_percent(amstar_clow_per, 1)`). The most common critical weaknesses in methodological quality were *not providing justification for excluding individual studies* (`r amstar_crit_mode$n[1]` reviews; `r format_percent(amstar_crit_mode$percent[1], 1)`), *inadequate literature search process* (`r amstar_crit_mode$n[2]` reviews; `r format_percent(amstar_crit_mode$percent[2], 1)`), and *not assessing risk of bias in individual studies included in the review* (`r amstar_crit_mode$n[3]` reviews; `r format_percent(amstar_crit_mode$percent[3], 1)`). The most common non-critical weaknesses in methodological quality were *not reporting funding sources for included studies* (`r amstar_noncrit_mode$n[1]` reviews; `r format_percent(amstar_noncrit_mode$percent[1], 1)`), *not explaining the selection criteria used to identify included study designs* (`r amstar_noncrit_mode$n[2]` reviews; `r format_percent(amstar_noncrit_mode$percent[2], 1)`), and *not assessing the impact of risk of bias in individual studies on evidence synthesis results* (`r amstar_noncrit_mode$n[3]` reviews; `r format_percent(amstar_noncrit_mode$percent[3], 1)`). ROBIS assessments (see *Table 3*) yielded ratings of low risk of bias for `r robis_low` reviews (`r format_percent(robis_low_per, 1)`, unclear risk of bias for `r robis_unclear` review `r format_percent(robis_unclear_per, 1)`), and high risk of bias for `r robis_high` reviews (`r format_percent(robis_high_per, 1)`). Concerns about risk of bias were most commonly related to *synthesis and finding* (`r robis_concerns$n_decision[1]` reviews; `r format_percent(robis_concerns$per_decision[1], 1)`) and *identification and selection of studies* (`r robis_concerns$n_decision[2]` reviews; `r format_percent(robis_concerns$per_decision[2], 1)`).


### Overlap of Primary Studies Across Systematic Reviews

```{r overlap}
#number of included primary studies
num_elig_stud <- length(inc_ps)

#using citation matrix without headers, transpose data 
cmt <- as.data.frame(t(citation_matrix))
#save first row as new column names
colnames(cmt) <- cmt[2,]

#remove first row of column names and second row with current study inclusions
#create new variable to calculate number of studies in each review
df_overlap <- cmt %>% 
  slice(-1:-3) %>% 
  mutate(num_stud = rowSums(. == "1 - Yes")) 

#range and median of number of studies in each review
range(df_overlap$num_stud) 
median(df_overlap$num_stud) 

#Number and percentage of primary studies included in more than one review
#create flag for if study is in more than one review
cm_overlap <- ps_cm %>% 
  select(-`Current Review`, -refid) %>% 
  mutate(morethanone = ifelse(rowSums(. == "1 - Yes") > 1, "yes", "no"))

#number and % included in more than one review
num_inc_overlap <- sum(cm_overlap$morethanone == "yes")
num_inc_overlap_per <- sum(cm_overlap$morethanone == "yes") / nrow(cm_overlap) * 100

#Number and percentage of eligible primary studies included in more than one review
#filter for eligible primary studies
elig_cm <- ps_cm %>%
  filter(refid %in% inc_ps) %>% 
  select(-`Current Review`, -refid)

#create flag if eligible study is included in more than one review
elig_overlap <- elig_cm %>%
  mutate(morethanone = ifelse(rowSums(. == "1 - Yes") >1, "yes", "no"))

#number and % of eligible studies included in more than one review
num_elig_overlap <- sum(elig_overlap$morethanone == "yes")
num_elig_overlap_per <- ifelse(num_elig_overlap == 0, 0, num_elig_overlap / nrow(elig_overlap) * 100)

#Overall CCA percentage for all primary studies included across reviews
#create dataframe for ccaR input (1 = included; 0 = excluded)
ccar_input <- ps_cm %>% 
  select(-`Current Review`, -refid) %>% 
  mutate_at(vars(-study), ~ifelse(. == "1 - Yes", 1, 0))  

#calculate overall CCA
cca_included <- cca(ccar_input) 
cca_included

#Overall CCA percentage for primary studies meeting our eligibility criteria
ccar_input_elig <- ps_cm %>% 
  filter(refid %in% inc_ps) %>% 
  select(-`Current Review`, -refid) %>% 
  mutate_at(vars(-study), ~ifelse(. == "1 - Yes", 1, 0)) 

#calculate overall CCA
cca_eligible <- cca(ccar_input_elig)
cca_eligible

```


The number of primary studies included in each review ranged from `r min(df_overlap$num_stud)` to `r max(df_overlap$num_stud)`, with a median of `r round(median(df_overlap$num_stud))`. Of the `r nrow(ps_cm)` primary studies included across all reviews, `r num_inc_overlap` studies (`r format_percent(num_inc_overlap_per, 1)`) were included in more than one review (see *Figure 2*). Of the `r num_elig_stud` primary studies meeting our eligibility criteria, `r num_elig_overlap` studies (`r format_percent(num_elig_overlap_per, 1)`) were included in more than one review (see *Figure 3*). The overall CCA percentage for all primary studies included across reviews (`r format_percent(cca_included$CCA_Percentage, 1)`) was lower than the overall CCA percentage for primary studies meeting our eligibility criteria (`r format_percent(cca_eligible$CCA_Percentage, 1)`). These numbers indicate *only moderate* overlap across reviews in all primary studies, though *very high* overlap across reviews in primary studies eligible for our overview (i.e., school-based anxiety prevention delivered directly to students during school hours). 


## Characteristics of Eligible Primary Studies

```{r study-char}
#Range and median for primary study start and end dates 
#extract year from date variables
study_dates <- study_td %>% 
  mutate(start_year = as.numeric(str_extract(study_start_date, "[0-9]{4}")),
         end_year = as.numeric(str_extract(study_end_date, "[0-9]{4}")))

```


The `r num_elig_stud` primary studies on interventions delivered during school hours (see *Table 4*) were published between `r min(study_td$study_publication_year)` and `r max(study_td$study_publication_year)` (with a median of `r median(study_td$study_publication_year)`). Start dates for participant recruitment ranged from `r min(study_dates$start_year, na.rm = TRUE)` to `r max(study_dates$start_year, na.rm = TRUE)` (with a median of `r median(study_dates$start_year, na.rm = TRUE)`); end dates for completing data collection ranged from `r min(study_dates$end_year, na.rm = TRUE)` to `r max(study_dates$end_year, na.rm = TRUE)` (with a median of `r median(study_dates$end_year, na.rm = TRUE)`). Unless otherwise indicated, the percentages below include all studies in the denominator (including those with missing data).

### Study Design

```{r study-design}
#Number and percentage of intervention and comparison groups per study
#count number of groups within studies
count_num_groups <- study_td %>% 
  group_by(study_number_groups) %>% 
  summarize(n = n(),
            percent = n/nrow(study_td)*100)

#Number and percentage of studies with individual randomized trials
#number/% of individual randomized trials 
num_irct <- sum(study_td$study_research_design == "Randomized trial" & study_td$study_assignment_level == "Individual")
num_irct_per <- sum(study_td$study_research_design == "Randomized trial" & study_td$study_assignment_level == "Individual") / nrow(study_td) * 100 

#number/% of cluster randomized trials
num_crct <- sum(study_td$study_research_design == "Randomized trial" & study_td$study_assignment_level == "Cluster") 
num_crct_per <- sum(study_td$study_research_design == "Randomized trial" & study_td$study_assignment_level == "Cluster") / nrow(study_td) * 100 

#number/% of QEDs
num_qed <- sum(study_td$study_research_design == "QED - Regression adjustment")
num_qed_per <- sum(study_td$study_research_design == "QED - Regression adjustment") / nrow(study_td) * 100 

#Within cluster RCTs, number and percentage of studies that clustered by classrooms: 
#filter for cluster randomized trials
cluster_df <- study_td %>% 
  filter(study_research_design == "Randomized trial" & study_assignment_level == "Cluster")

#of cluster trials, number/% of classroom cluster type
cluster_class <- sum(cluster_df$study_cluster_level == "Classroom") 
cluster_class_per <- sum(cluster_df$study_cluster_level == "Classroom") / nrow(cluster_df) * 100 

#of cluster trials, number/% of school cluster type
cluster_schl <- sum(cluster_df$study_cluster_level == "School") 
cluster_schl_per <- sum(cluster_df$study_cluster_level == "School") / nrow(cluster_df) * 100 

#of cluster trials, number/% of district cluster type
cluster_dist <- sum(cluster_df$study_cluster_level == "District") 
cluster_dist_per <- sum(cluster_df$study_cluster_level == "District") / nrow(cluster_df) * 100 

#range/median of cluster size
range(cluster_df$study_cluster_size, na.rm = TRUE) 
median(cluster_df$study_cluster_size, na.rm = TRUE)

#Research transparency
#of all studies, number/% with flow diagram
num_consort <- sum(study_td$study_flow_diagram == "Yes")
num_consort_per <- sum(study_td$study_flow_diagram == "Yes") / nrow(study_td) * 100 

#of all studies, number/% with registration number
num_study_reg <- sum(study_td$study_registration != "-999") 
num_study_reg_per <- sum(study_td$study_registration != "-999") / nrow(study_td) * 100 

#of all studies, number/% with availability statement
num_study_avail <- sum(study_td$study_availability_statement != "-999") 
num_study_avail_per <- sum(study_td$study_availability_statement != "-999") / nrow(study_td) * 100 


```

Regarding number of interventions and comparisons trialed per study, `r count_num_groups$n[1]` studies (`r format_percent(count_num_groups$percent[1], 1)`) had two groups, `r count_num_groups$n[2]` studies (`r format_percent(count_num_groups$percent[2], 1)`) had three groups, and `r count_num_groups$n[3]`studies (`r format_percent(count_num_groups$percent[3], 1)`) had four groups. In terms of study design, `r num_irct` studies (`r format_percent(num_irct_per, 1)`) randomized individual students to interventions, `r num_crct`studies (`r format_percent(num_crct_per, 1)`) randomized clusters of students to interventions, and `r num_qed`studies (`r format_percent(num_qed_per, 1)`) used non-random assignment. Of the `r num_crct` cluster-randomized trials, `r cluster_schl` studies (`r format_percent(cluster_schl_per, 1)`) randomized schools, `r cluster_class` studies (`r format_percent(cluster_class_per, 1)`) randomized classrooms, and `r cluster_dist` study (`r format_percent(cluster_dist_per, 1)`) randomized districts . Among the cluster-randomized trials reporting this information, the average cluster size ranged from `r round(min(cluster_df$study_cluster_size, na.rm = TRUE))` to `r round(max(cluster_df$study_cluster_size, na.rm = TRUE))` (with a median of `r round(median(cluster_df$study_cluster_size, na.rm = TRUE), 1)`). Regarding research transparency, `r num_consort`studies (`r format_percent(num_consort_per, 1)`) included a flow diagram of participants through the different phases of the study, `r num_study_reg`studies (`r format_percent(num_study_reg_per, 1)`) reported a registration number for their study, and `r num_study_avail` studies (`r format_percent(num_study_avail_per, 1)`) provided statements about the data and code underlying the results that they reported.

### Participants

```{r study-participants}
#number of students across primary studies
num_studs <- format(sum(study_td$study_number_participants), big.mark = ",") 

#Number and percent of studies that took place in elementary or primary schools
#create count variables per school level since some responses contain more than one school type
count_school_level <- study_td %>% 
  mutate(elem_count = str_count(study_school_level, "Elementary") + str_count(study_school_level, "Primary"),
         mid_count = str_count(study_school_level, "Middle"),
         high_count = str_count(study_school_level, "High") + str_count(study_school_level, "Secondary")) 

#number/% studies in elementary or primary school
study_elem <- sum(count_school_level$elem_count) 
study_elem_per <- study_elem / nrow(study_td) * 100 

#number/% studies in middle school
study_mid <- sum(count_school_level$mid_count) 
study_mid_per <- study_mid / nrow(study_td) * 100 

#number/% studies in high or secondary school
study_high <- sum(count_school_level$high_count) 
study_high_per <- study_high / nrow(study_td) * 100 

#Calculate most common grade levels among studies:
#create flag variables per grade level since some responses contain more than one school type
count_grade_level <- study_td %>% 
  mutate(k_flag = str_count(study_grade_level, "k"),
         first_flag = str_count(study_grade_level, "1"), 
         second_flag = str_count(study_grade_level, "2"), 
         third_flag = str_count(study_grade_level, "3"), 
         fourth_flag = str_count(study_grade_level, "4"), 
         fifth_flag = str_count(study_grade_level, "5"), 
         sixth_flag = str_count(study_grade_level, "6"), 
         seventh_flag = str_count(study_grade_level, "7"), 
         eighth_flag = str_count(study_grade_level, "8"), 
         ninth_flag = str_count(study_grade_level, "9"), 
         tenth_flag = str_count(study_grade_level, "10"),
         eleventh_flag = str_count(study_grade_level, "11"),
         twelveth_flag = str_count(study_grade_level, "12")) %>% 
  select(refid, study_grade_level, ends_with("flag")) %>% 
  pivot_longer(cols = k_flag:twelveth_flag,
               names_to = "grade") %>% 
  group_by(grade) %>% 
  summarize(n = sum(value),
            percent = n/nrow(study_td)*100) %>% 
  arrange(desc(n))

#Range and median of percentage of female students among primary studies
#range and median of % female
min_female <- paste0(min(study_td$study_percent_female, na.rm = TRUE), "%")
max_female <- paste0(max(study_td$study_percent_female, na.rm = TRUE) * 100, "%")
med_female <- paste0(median(study_td$study_percent_female, na.rm = TRUE) * 100, "%")

#Of studies conducted in the U.S., range and median of percentage of white students:
#create subset with only studies conducted in U.S.
US_study <- study_td %>% 
  filter(study_country == "United States")

#of US studies, range and median of % white
min_white <- paste0(min(US_study$study_percent_white * 100, na.rm = TRUE), "%")
max_white <- paste0(max(US_study$study_percent_white * 100, na.rm = TRUE), "%")
med_white <- format_percent(median(US_study$study_percent_white, na.rm = TRUE) * 100, 1)

#of US studies, range and median of % ell
min_ell <- paste0(min(US_study$study_percent_ell * 100, na.rm = TRUE), "%")
max_ell <- paste0(max(US_study$study_percent_ell * 100, na.rm = TRUE), "%")
med_ell <- format_percent(median(US_study$study_percent_ell, na.rm = TRUE) * 100, 1)

#of US studies, range and median of % frpl
min_frpl <- paste0(min(US_study$study_percent_frpl * 100, na.rm = TRUE), "%")
max_frpl <- paste0(max(US_study$study_percent_frpl * 100, na.rm = TRUE), "%")
med_frpl <- format_percent(median(US_study$study_percent_frpl, na.rm = TRUE) * 100, 1)

```


The `r num_elig_stud` included primary studies included `r num_studs` students (median: `r median(study_td$study_number_participants, na.rm = TRUE)` students per study, range: `r min(study_td$study_number_participants, na.rm = TRUE)` to `r format_thousands(max(study_td$study_number_participants, na.rm = TRUE))`), `r sum(study_td$study_number_classrooms, na.rm = TRUE)` classrooms (median: `r median(study_td$study_number_classrooms, na.rm = TRUE)` classrooms per study, range: `r min(study_td$study_number_classrooms, na.rm = TRUE)` to `r max(study_td$study_number_classrooms, na.rm = TRUE)`, and `r sum(study_td$study_number_schools, na.rm = TRUE) ` schools (median: `r median(study_td$study_number_schools, na.rm = TRUE)` schools per study, range: `r min(study_td$study_number_schools, na.rm = TRUE)` to `r max(study_td$study_number_schools, na.rm = TRUE)`). The average age of students ranged from `r round(min(study_td$study_age_average, na.rm = TRUE), 1)` to `r max(study_td$study_age_average, na.rm = TRUE)` (with a median of `r round(median(study_td$study_age_average, na.rm = TRUE), 1)`). Regarding school level, `r study_elem` studies (`r format_percent(study_elem_per, 1)`) took place in primary/elementary school, `r study_mid` studies (`r format_percent(study_mid_per, 1)`) took place in intermediate/middle school, and `r study_high` studies (`r format_percent(study_high_per, 1)`) took place in secondary/high school. The most common grade levels were 4th grade (`r count_grade_level$n[1]` studies; `r format_percent(count_grade_level$percent[1], 1)`), 6th grade (`r count_grade_level$n[2]` studies; `r format_percent(count_grade_level$percent[2], 1)`), 5th grade (`r count_grade_level$n[3]` studies; `r format_percent(count_grade_level$percent[3], 1)`), 1st grade (`r count_grade_level$n[4]` studies; `r format_percent(count_grade_level$percent[4], 1)`), and 3rd grade (`r count_grade_level$n[5]` studies; `r format_percent(count_grade_level$percent[5], 1)`). The average percentage of students who were female ranged from `r min_female` to `r max_female`(with a median of `r med_female`). 

### Settings

```{r study-setting}
#Most common countries where primary studies took place: 
#count most common countries
count_country <- study_td %>% 
  group_by(study_country) %>% 
  summarize(n = n(),
            percent = n/nrow(study_td)*100) %>% 
  arrange(desc(n))

#of US countries, count most common states
count_states <- US_study %>% 
  group_by(study_state) %>% 
  summarize(n = n(),
            percent = n/nrow(US_study)*100) %>% 
  arrange(desc(n))

#Of studies reporting area type, number and percentage of studies that took place in each area type: #count location type by creating new count variable since more than one are listed per cell
count_urbanicity <- study_td %>% 
  filter(study_school_area != "Cannot tell") %>% 
  mutate(rural_count = str_count(study_school_area, "Rural"),
         suburban_count = str_count(study_school_area, "Suburban"), 
         urban_count = str_count(study_school_area, "Urban")) %>% 
  select(refid, study_school_area, ends_with("count")) %>% 
  pivot_longer(cols = rural_count:urban_count,
               names_to = "area_type") %>% 
  group_by(area_type) %>% 
  summarize(n = sum(value),
            percent = sum(value)/sum(study_td$study_school_area != "Cannot tell")*100) %>% 
  arrange(desc(n))

#Of studies reporting school type, number and percentage of studies with each school type: 
#count school type by creating new variables since more than one per cell
count_schooltype <- study_td %>% 
  filter(study_school_type != "Cannot Tell") %>% 
  mutate(public_count  = str_count(study_school_type, "Public"),
         private_count = str_count(study_school_type, "Private"), 
         charter_count = str_count(study_school_type, "Charter"),
         parochial_count = str_count(study_school_type, "Parochial")) %>% 
  select(refid, study_school_type, ends_with("count")) %>% 
  pivot_longer(cols = public_count:parochial_count,
               names_to = "schooltype") %>% 
  group_by(schooltype) %>% 
  summarize(n = sum(value),
            percent = sum(value)/sum(study_td$study_school_type != "Cannot Tell")*100) %>% 
  arrange(desc(n))

```

Studies took place in Australia (`r count_country$n[1]` studies; `r format_percent(count_country$percent[1], 1)`), Canada (`r count_country$n[2]` studies; `r format_percent(count_country$percent[2], 1)`), United Kingdom (`r count_country$n[3]` studies; `r format_percent(count_country$percent[3], 1)`), and Ireland (`r count_country$n[4]` studies; *no studies took place in the United States*. Of the `r sum(study_td$study_school_area != "Cannot tell")` studies (`r format_percent(sum(study_td$study_school_area != "Cannot tell") / nrow(study_td) * 100, 1)`) reporting information on area type, `r count_urbanicity$n[1]` studies (`r format_percent(count_urbanicity$percent[1], 1)`) took place in urban areas, `r count_urbanicity$n[2]` studies (`r format_percent(count_urbanicity$percent[2], 1)`) took place in rural areas, and `r count_urbanicity$n[3]` studies (`r format_percent(count_urbanicity$percent[3], 1)`) took place in suburban areas. Of the `r sum(study_td$study_school_type != "Cannot tell")` studies (`r format_percent(sum(study_td$study_school_type != "Cannot tell") / nrow(study_td) * 100, 1)`) reporting information on school type, `r count_schooltype$n[1]` studies (`r format_percent(count_schooltype$percent[1], 1)`) took place in public schools, `r count_schooltype$n[2]` studies (`r format_percent(count_schooltype$percent[2], 1)`) took place in parochial schools, and `r count_schooltype$n[3]` studies (`r format_percent(count_schooltype$percent[3], 1)`) took place in private schools. 

### Experimental Interventions

```{r study-interventions}
#filter for experimental interventions 
grp_int <- group_td %>% 
  filter(study_group_type == "Intervention") 

#number of experimental interventions (group type)
nrow(grp_int)

#Number and percentage of each intervention format: 
#number/% of format (intervention_format)
count_format <- grp_int %>% 
  group_by(study_group_format) %>% 
  filter(study_group_format != "Cannot tell") %>% 
  mutate(individual_count = str_count(study_group_format, "Self-Administered"),
         group_count = str_count(study_group_format, "Small Group"), 
         class_count = str_count(study_group_format, "Whole Class")) %>% 
  select(refid, study_group_format, ends_with("count")) %>% 
  ungroup() %>% 
  pivot_longer(cols = individual_count:class_count,
               names_to = "format_type") %>% 
  group_by(format_type) %>% 
  summarize(n = sum(value),
            percent = sum(value)/nrow(grp_int)*100) %>% 
  arrange(desc(n))

#Of interventions reporting frequency of delivery, number and percentage of interventions with each frequency: 
#Of those reporting frequency, number/% of frequency
count_delivery <- grp_int %>% 
  filter(study_group_frequency  != "Cannot tell") %>% 
  group_by(study_group_frequency ) %>% 
  summarize(n = n(),
            percent = n/sum(grp_int$study_group_frequency != "Cannot tell")*100)

#Of interventions reporting provider, number and percentage of interventions with each provider type
#of those reporting provider, number/% by provider, create count variable since more than one reponse per cell
count_intprovider <- grp_int %>% 
  filter(study_group_provider != "Cannot tell") %>% 
  mutate(teacher_count  = str_count(study_group_provider, "Teacher"),
         counselor_count = str_count(study_group_provider, "Counselor"), 
         bhpersonnel_count = str_count(study_group_provider, "Behavioral Health Personnel"),
         researcher_count = str_count(study_group_provider, "Researcher"),
         schlpersonnel_count = str_count(study_group_provider, "Other School Personnel"),
         self_count = str_count(study_group_provider, "Self-Administered"),
         other_count = str_count(study_group_provider, "Other")) %>% 
  select(refid, study_group_provider, ends_with("count")) %>% 
  pivot_longer(cols = teacher_count:other_count,
               names_to = "provider") %>% 
  group_by(provider) %>% 
  summarize(n = sum(value),
            percent = sum(value)/sum(grp_int$study_group_provider != "Cannot Tell") *100) %>% 
  arrange(desc(n))

#Of interventions reporting recipient type, number and percentage of interventions with each recipient type: 
#of those reporting recipient, number/% by recipient type, create count variable since more than one response per cell
count_intrecip <- grp_int %>% 
  filter(study_group_recipients != "Cannot tell") %>% 
  mutate(student_count  = str_count(study_group_recipients, "Student"),
         peers_count = str_count(study_group_recipients, "Peers"), 
         teacher_count = str_count(study_group_recipients, "Teacher"),
         staff_count = str_count(study_group_recipients, "Staff"),
         family_count = str_count(study_group_recipients, "Family"),
         community_count = str_count(study_group_recipients, "Community")) %>% 
  select(refid, study_group_recipients, ends_with("count")) %>% 
  pivot_longer(cols = student_count:community_count,
               names_to = "recipients") %>% 
  group_by(recipients) %>% 
  summarize(n = sum(value),
            percent = sum(value)/sum(grp_int$study_group_recipients != "Cannot Tell") *100) %>% 
  arrange(desc(n))

#Of interventions reporting location, number and percentage of interventions with each location type: 
#of those reporting location, number/% by location type, create count variable since more than one response per cell
count_intloc <- grp_int %>% 
  filter(study_group_location != "Cannot tell") %>% 
  mutate(inschl_count  = str_count(study_group_location, "During School Hours"),
         outschl_count = str_count(study_group_location, "Out-of-School Time"), 
         home_count = str_count(study_group_location, "Home"),
         community_count = str_count(study_group_location, "Community"),
         residential_count = str_count(study_group_location, "Residential"),
         other_count = str_count(study_group_location, "Other")) %>% 
  select(refid, study_group_location, ends_with("count")) %>% 
  pivot_longer(cols = inschl_count:other_count,
               names_to = "location") %>% 
  group_by(location) %>% 
  summarize(n = sum(value),
            percent = sum(value)/sum(grp_int$study_group_location != "Cannot tell") *100) %>% 
  arrange(desc(n))

#Of interventions reporting delivery, number and percentage of interventions with each delivery mode type
#of those reporting delivery mode, number/% by delivery mode, create count variable since more than one response per cell
count_intmode <- grp_int %>% 
  filter(study_group_mode != "Cannot tell") %>% 
  mutate(inperson_count  = str_count(study_group_mode, "In-Person"),
         internet_count = str_count(study_group_mode, "Internet"), 
         phone_count = str_count(study_group_mode, "Phone")) %>% 
  select(refid, study_group_mode, ends_with("count")) %>% 
  pivot_longer(cols = inperson_count:phone_count,
               names_to = "mode") %>% 
  group_by(mode) %>% 
  summarize(n = sum(value),
            percent = sum(value)/sum(grp_int$study_group_mode != "Cannot tell") *100) %>% 
  arrange(desc(n))

#Number and percentage of studies with reported information on implementation monitoring
#create new variable that will flag if a study had any group that reported any implementation info 
group_study_flag <- grp_int %>% 
  #group_by(refid) %>% 
  mutate(monitor_flag = case_when(study_implementation_monitoring == "Yes" ~ "Yes",
                                  TRUE ~ study_implementation_monitoring),
         problem_flag = case_when(study_implementation_problems == "Yes" ~ "Yes",
                                  TRUE ~ study_implementation_problems)) %>% 
  #ungroup() %>% 
  select(refid, ends_with("flag"))# %>% 
 # distinct(refid, .keep_all = TRUE)

#number/% reporting implementation monitoring 
num_implem_mon <- sum(group_study_flag$monitor_flag == "Yes") 
num_implem_mon_per <- sum(group_study_flag$monitor_flag == "Yes") / nrow(group_study_flag) * 100

#number/% reporting implementation problems
num_implem_prob <- sum(group_study_flag$problem_flag == "Yes") 
num_implem_prob_per <- sum(group_study_flag$problem_flag == "Yes") / nrow(group_study_flag) * 100 


```


Across all `r num_elig_stud` primary studies, `r nrow(grp_int)` experimental interventions were evaluated. Regarding format of the `r nrow(grp_int)` experimental interventions, `r count_format$n[2]` (`r format_percent(count_format$percent[2], 1)`) were administered to individual students, `r count_format$n[3]` (`r format_percent(count_format$percent[3], 1)`) were administered to small groups, and `r count_format$n[1]` (`r format_percent(count_format$percent[1], 1)`) were administered to whole classes. The duration of interventions ranged from `r min(grp_int$study_group_duration, na.rm = TRUE) ` to `r max(grp_int$study_group_duration, na.rm = TRUE) ` weeks (with a median of `r median(grp_int$study_group_duration, na.rm = TRUE)`), the number of sessions ranged from `r min(grp_int$study_group_sessions, na.rm = TRUE)` to `r max(grp_int$study_group_sessions, na.rm = TRUE)` sessions (with a median of `r median(grp_int$study_group_sessions, na.rm = TRUE)`), and the length of each session ranged from `r min(grp_int$study_group_intensity, na.rm = TRUE)` to `r max(grp_int$study_group_intensity, na.rm = TRUE)` minutes (with a median of `r median(grp_int$study_group_intensity, na.rm = TRUE)`). Of the `r sum(grp_int$study_group_frequency != "Cannot tell")` interventions for which frequency of intervention delivery was reported, `r count_delivery$n[2]` interventions (`r format_percent(count_delivery$percent[2], 1)`) were delivered less than weekly, `r count_delivery$n[3]` interventions (`r format_percent(count_delivery$percent[3], 1)`) were delivered once a week, and `r count_delivery$n[1]` interventions (`r format_percent(count_delivery$percent[1], 1)`) were delivered 2-4 times a week. Of the `r sum(grp_int$study_group_provider != "Cannot tell")` interventions for which provider information was reported, `r count_intprovider$n[1]` interventions (`r format_percent(count_intprovider$percent[1], 1)`) by teachers, `r count_intprovider$n[2]` interventions (`r format_percent(count_intprovider$percent[2], 1, force_decimal = TRUE)`) by behavioral health personnel, `r count_intprovider$n[3]` interventions (`r format_percent(count_intprovider$percent[3], 1)`) were delivered by researchers, `r count_intprovider$n[4]` (`r format_percent(count_intprovider$percent[4], 1)`) were self-administered, `r count_intprovider$n[5]` interventions (`r format_percent(count_intprovider$percent[5], 1)`) by guidance counselors, `r count_intprovider$n[7]` interventions (`r format_percent(count_intprovider$percent[7], 1)`) by other school personnel, and `r count_intprovider$n[6]` interventions (`r format_percent(count_intprovider$percent[6], 1)`) by other providers. Of the `r sum(grp_int$study_group_recipients != "Cannot tell")` interventions for which recipient information was reported, all interventions (`r format_percent(count_intrecip$percent[1], 1)`) were delivered directly to students, `r count_intrecip$n[2]` interventions (`r format_percent(count_intrecip$percent[2], 1)`) to peers, `r count_intrecip$n[3]` interventions (`r format_percent(count_intrecip$percent[3], 1)`) to family, `r count_intrecip$n[4]` intervention (`r format_percent(count_intrecip$percent[4], 1)`) to the community, `r count_intrecip$n[5]` intervention (`r format_percent(count_intrecip$percent[5], 1)`) to staff, and `r count_intrecip$n[6]` intervention (`r format_percent(count_intrecip$percent[6], 1)`) to teachers. In addition to delivery during school hours, `r count_intloc$n[2]` interventions (`r format_percent(count_intloc$percent[2], 1)`) also involved a component that took place out-of-school time but on school groups (e.g., after school), `r count_intloc$n[3]` interventions (`r format_percent(count_intloc$percent[3], 1)`) involved a component that took place at home, and `r count_intloc$n[4]` intervention (`r format_percent(count_intloc$percent[4], 1)`) involved a component that took place in the community. Of the `r sum(grp_int$study_group_mode != "Cannot tell")` interventions for which intervention mode was reported, `r count_intmode$n[1]` interventions (`r format_percent(count_intmode$percent[1], 1, force_decimal = TRUE)`) involved in-person delivery, `r count_intmode$n[2]` interventions (`r format_percent(count_intmode$percent[2], 1)`) involved digital delivery, and no interventions (`r format_percent(count_intmode$percent[3], 1)`) involved phone delivery. Across the `r nrow(grp_int)` interventions, `r num_implem_mon` (`r format_percent(num_implem_mon_per, 1, force_decimal = TRUE)`) reported monitoring intervention implementation to assess delivery as intended, and `r num_implem_prob` (`r format_percent(num_implem_prob_per, 1)`) reported that there was uncontrolled variation or degradation in intervention implementation.

### Comparison Interventions

```{r study-comparison}
#filter for comparison interventions 
grp_comp <- group_td %>% 
  filter(study_group_type == "Comparison")

#number/% of comparison group type (comparison_type)
count_comptype <- grp_comp %>% 
  group_by(study_group_comparison_type) %>% 
  summarize(n = n(),
            percent = n/nrow(grp_comp)*100) %>% 
  arrange(desc(n))


```


Overall, the `r num_elig_stud` primary studies had `r nrow(grp_comp)` comparison interventions. Of these `r nrow(grp_comp)` comparison interventions, `r count_comptype$n[1]` (`r format_percent(count_comptype$percent[1], 1)`) involved business-as-usual, `r count_comptype$n[2]` (`r format_percent(count_comptype$percent[2], 1)`) involved a wait-list control, `r count_comptype$n[3]` (`r format_percent(count_comptype$percent[3], 1, force_decimal = TRUE)`) involved no intervention, `r count_comptype$n[4]` (`r format_percent(count_comptype$percent[4], 1)`) involved an attention-control intervention, and `r count_comptype$n[5]` (`r format_percent(count_comptype$percent[5], 1)`) involved a different active intervention. 

### Risks of Bias

```{r study-rob}
#Individual RCTs
count_irobtot <- irob_td %>% 
  group_by(irob_overall_decision) %>% 
  summarize(n = n(), 
            percent = n/nrow(irob_td)*100)
#calculate most common domains with High ratings
count_irobratings <- irob_td %>% 
  pivot_longer(cols = irob_domain1_judgment:irob_domain5_judgment) %>% 
  group_by(name) %>% 
  summarize(n = sum(value == "High"),
            percent = sum(value == "High") / nrow(irob_td) * 100) %>% 
  arrange(desc(n))
count_irobratings

#Cluster RCTs
#number/% for overall rating
count_crobtot <- crob_td %>% 
  group_by(crob_overall_judgment) %>% 
  summarize(n = n(), 
            percent = n/nrow(crob_td)*100)
#calculate most common domains with High ratings
count_crobratings <- crob_td %>% 
  pivot_longer(cols = crob_domain1a_judgment:crob_domain5_judgment) %>% 
  group_by(name) %>% 
  summarize(n = sum(value == "High"),
            percent = sum(value == "High") / nrow(crob_td) * 100) %>% 
  arrange(desc(n))

#QEDs
#number/% for overall rating
count_robinstot <- robins_td %>% 
  group_by(robins_overall_judgment) %>% 
  summarize(n = n(), 
            percent = n/nrow(robins_td)*100) %>% 
  arrange(desc(n))
#calculate most common domains with Serious or Critical ratings
count_robinsratings <- robins_td %>% 
  pivot_longer(cols = robins_domain1_judgment:robins_domain7_judgment) %>% 
  group_by(name) %>% 
  summarize(n = sum(value == "Serious") + sum(value == "Critical"),
            percent = (sum(value == "Serious") + sum(value == "Critical")) / nrow(robins_td) * 100) %>% 
  arrange(desc(n))

```

Of the `r nrow(irob_td)` individually-randomized trials, we rated `r count_irobtot$n[1]` studies (`r format_percent(count_irobtot$percent[1], 1)`) as high risk of bias and `r count_irobtot$n[2]` studies (`r format_percent(count_irobtot$percent[2], 1)`) as having some concerns. Concerns about risk of bias were most commonly related to random allocation (`r count_irobratings$n[1]` studies; `r format_percent(count_irobratings$percent[1], 1)`) and missing outcome data (`r count_irobratings$n[2]` studies; `r format_percent(count_irobratings$percent[2], 1)`). Of the `r nrow(crob_td)` cluster-randomized trials, we rated `r count_crobtot$n[1]` studies (`r format_percent(count_crobtot$percent[1], 1)`) as high risk of bias and `r count_crobtot$n[2]` studies (`r format_percent(count_crobtot$percent[2], 1)`) as having some concerns. Concerns about risk of bias were most commonly related to missing outcome data (`r count_crobratings$n[1]` studies; `r format_percent(count_crobratings$percent[1], 1)`), random allocation (`r count_crobratings$n[2]` studies; `r format_percent(count_crobratings$percent[2], 1)`), recruitment (`r count_crobratings$n[3]` studies; `r format_percent(count_crobratings$percent[3], 1)`), and assignment deviation (`r count_crobratings$n[4]`studies; `r format_percent(count_crobratings$percent[4], 1)`). Of the `r nrow(robins_td)` non-randomized trials, we rated `r count_robinstot$n[1]` studies (`r format_percent(count_robinstot$percent[1], 1)`) as critical risk of bias and `r count_robinstot$n[2]` studies (`r format_percent(count_robinstot$percent[2], 1)`) as having moderate risk of bias. Serious or critical concerns about risk of bias were most commonly related to confounding (`r count_robinsratings$n[1]` studies; `r format_percent(count_robinsratings$percent[1], 1)`) and missing data (`r count_robinsratings$n[2]` studies; `r format_percent(count_robinsratings$percent[2], 1)`).

# Figures, Tables, Appendices

Figure 1 is PRISMA diagram created in Word.

### Figure 2. Overlap of included studies across systematic reviews

Create CCA heatmap of overlap of included studies across reviews:

```{r ccaR-f2}
#format citation matrix including our review
cca_inc <- ps_cm %>% 
  select(-refid) %>% 
  mutate_at(vars(-study), ~ifelse(. == "1 - Yes", 1, 0)) %>% 
  rename(` Current Review` = `Current Review`)

#create pairwise heatmap with CCA(%), including our review
f2 <- cca_heatmap(cca_inc, decimal_digits = 0, fontsize = 7.5, fontsize_diag = 4.5) +
  ggplot2::theme(
      plot.caption = ggplot2::element_text(size = 16, margin=ggplot2::margin(30,0,0,0)),
      legend.title = ggplot2::element_text(size = 16, face = "bold", vjust=4),
      legend.text = ggplot2::element_text(size = 16),
      legend.key.size = ggplot2::unit(1.0, "cm"),
      legend.title.align = 0.5,
      legend.text.align = 0.5,
      axis.text.x=ggplot2::element_text(size = 22),
      axis.text.y=ggplot2::element_text(size = 22),
      axis.title=ggplot2::element_blank(),
      axis.ticks=ggplot2::element_blank(),
      axis.line=ggplot2::element_blank(),
      panel.border=ggplot2::element_blank(),
      panel.grid.major.x=ggplot2::element_line(colour = "grey80", linetype = "dashed"))

f2

```

Save figure 2 to `outputs/figures` project folder: 

```{r save-f2}
# #set image dimensions and file path to save
# png(here("outputs", "figures", "figure2_heatmap.png"), width = 1000, height = 1000)
# 
# #show plot
# f2
# 
# #save png of plot
# dev.off()
```

### Figure 3. Overlap of eligible studies across systematic reviews

Filter for studies that met our inclusion criteria and create CCA heatmap of our eligible studies across reviews: 

```{r ccaR-elig-f3}
#format citation matrix of eligible studies, including our review
cca_elig <- ps_cm %>% 
  filter(refid %in% inc_ps_wlinked) %>% 
  select(-refid) %>% 
  mutate_at(vars(-study), ~ifelse(. == "1 - Yes", 1, 0))  %>% 
  rename(` Current Review` = `Current Review`)

#create pairwise heatmap with CCA(%)
f3 <- cca_heatmap(cca_elig, decimal_digits = 0, fontsize = 7.5, fontsize_diag = 4.5) +
  ggplot2::theme(
      plot.caption = ggplot2::element_text(size = 16, margin=ggplot2::margin(30,0,0,0)),
      legend.title = ggplot2::element_text(size = 16, face = "bold", vjust=4),
      legend.text = ggplot2::element_text(size = 16),
      legend.key.size = ggplot2::unit(1.0, "cm"),
      legend.title.align = 0.5,
      legend.text.align = 0.5,
      axis.text.x = ggplot2::element_text(size = 22),
      axis.text.y = ggplot2::element_text(size = 22),
      axis.title = ggplot2::element_blank(),
      axis.ticks = ggplot2::element_blank(),
      axis.line = ggplot2::element_blank(),
      panel.border = ggplot2::element_blank(),
      panel.grid.major.x = ggplot2::element_line(colour = "grey80", linetype = "dashed"))

print(f3)

```

Save figure 3 to `outputs/figures` project folder: 

```{r save-f3}
# #set image dimensions and file path to save
# png(here("outputs", "figures", "figure3_heatmap.png"), width = 1000, height = 1000)
# 
# #show plot
# f3
# 
# #save png of plot
# dev.off()
```


### Table 1. Descriptive characteristics per each included systematic review

```{r t1-reviewchar}
#select info we for table1
t1_info <- review_td %>% 
  select(refid, review_author_year, review_databases_searched, review_search_date)

#transform to long to calculate # of included/eligible studies per review
cm_long <- ps_cm %>% 
  select(-`Current Review`, -refid) %>% 
  pivot_longer(cols = `Ahlen 2015`:`Zhelinsky-Denyer 2015`,
               names_to = "review_author_year") 

#count number of included studies per review
numinc_perreview <- cm_long %>% 
  group_by(review_author_year) %>% 
  summarize(n_included = sum(value == "1 - Yes", na.rm = TRUE)) %>% 
  ungroup()

#create list of included study names for merging
inc_ps_name <- ps_cm %>% 
  filter(refid %in% inc_ps_wlinked) %>% 
  pull(study)

#count number of eligible studies per review
numelig_perreview <- cm_long %>% 
  filter(study %in% inc_ps_name) %>% 
  group_by(review_author_year) %>% 
  summarize(n_eligible = sum(value == "1 - Yes", na.rm = TRUE)) %>% 
  ungroup()

#merge and format values
t1 <- left_join(t1_info, numinc_perreview) %>% 
  left_join(numelig_perreview) %>% 
  mutate(search_date_format = ifelse(nchar(review_search_date) == 10, format(ymd(review_search_date), "%B %d, %Y"), review_search_date)) %>% 
  mutate(search_date_format = ifelse(nchar(review_search_date) == 7, format(ym(review_search_date), "%B %Y"), search_date_format)) %>% 
  mutate_all(~ replace(., . == -999, "Not Reported")) %>% 
  select(review_author_year, review_databases_searched, search_date_format, n_included, n_eligible) %>% 
  arrange(str_to_lower(review_author_year))

#create gt table and format
table1_formatted <- t1 %>% 
  gt() %>% 
  cols_align(columns = c("n_included", "n_eligible"), align = "center") %>% 
  tab_style(style = cell_text(align = "left"), locations = cells_column_labels(columns = c("n_included", "n_eligible"))) %>%
  cols_width(review_author_year ~ px(125), review_databases_searched ~ px(275), search_date_format ~ px(150), starts_with("n") ~ px(75)) %>% 
  cols_label(review_author_year = "Review", 
            review_databases_searched = "Databases Searched",
            search_date_format = "Search Date",
            n_included = "Included Studies",
            n_eligible = "Eligible Studies") %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1))),
            locations = cells_body(columns = everything())) %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1)),
                         cell_text(weight = "bold")),
            locations = cells_column_labels()) %>% 
  tab_options(column_labels.border.top.color = "black",
              column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table.border.top.color = "white",
              heading.border.bottom.color = "black",
              table_body.hlines.color = "white",
              table.font.names = "Times New Roman")

print(table1_formatted)

```

```{r save-t1}
#save table
#save as word doc
#gtsave(table1_formatted, filename = "table1_word.docx", device = "word", path = here("outputs", "tables"), landscape = TRUE) #landscape doesn't work

#save as pdf
#gtsave(table1_formatted, filename = "table1.pdf") 

#save as html with larger column widths
table1_html <- table1_formatted %>% 
  cols_width(review_author_year ~ px(175), review_databases_searched ~ px(700), search_date_format ~ px(150), starts_with("n") ~ px(75))

#gtsave(table1_html, filename = "table_1.html", path = here("outputs", "tables"))

#export as excel to transfer to word - word output not working on gt table
#rio::export(t1, here("outputs", "tables", "t1_excel.xlsx"))

```


### Table 2. AMSTAR-2 Ratings per Question

```{r t2-amstar}
#re-format ratings to report in table 2
t2 <- amstar_rating_td %>% 
  mutate(review_author_year = as.factor(review_author_year)) %>% 
  mutate_if(is.character, ~case_when(. == "HIGH" ~ "H",
                                     . == "MODERATE" ~ "M",
                                     . == "LOW" ~ "L",
                                     . == "CRITICALLY LOW" ~ "CL",
                                     . == "Yes" ~ "Y",
                                     . == "Partial Yes" ~ "PY",
                                     . == "No" ~ "N",
                                     TRUE ~ .)) %>% 
  select(-refid, -amstar_11nrsi_rating, -amstar_9nrsi_rating) %>% #temporarily remove nrsi ratings to fit template
  arrange(str_to_lower(review_author_year))

#create gt table and format
t2_formatted <- t2 %>% 
  gt() %>% 
  cols_label(review_author_year = "Review", 
            amstar_overall_rating = "Overall",
            amstar_1_rating = "1",
            amstar_2_rating = "2",
            amstar_3_rating = "3",
            amstar_4_rating = "4",
            amstar_5_rating = "5",
            amstar_6_rating = "6",
            amstar_7_rating = "7",
            amstar_8_rating = "8",
            amstar_9rct_rating = "9",
            amstar_10_rating = "10",
            amstar_11rct_rating = "11",
            amstar_12_rating = "12",
            amstar_13_rating = "13",
            amstar_14_rating = "14",
            amstar_15_rating = "15",
            amstar_16_rating = "16") %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1))),
            locations = cells_body(columns = everything())) %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1)),
                         cell_text(weight = "bold")),
            locations = cells_column_labels()) %>% 
   tab_options(column_labels.border.top.color = "black",
              column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table.border.top.color = "white",
              heading.border.bottom.color = "black",
              table_body.hlines.color = "white",
              table.border.bottom.color = "white",
              table.font.names = "Times New Roman") %>% 
  cols_width(review_author_year ~ px(175),
             amstar_overall_rating ~ px(75),
             everything() ~ px(35)) %>% 
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = everything())) %>% 
  tab_style(style = cell_text(align = "left"), locations = cells_column_labels(columns = "review_author_year")) %>% 
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = everything())) %>% 
  tab_style(style = cell_text(align = "left"), locations = cells_body(columns = "review_author_year")) %>% 
  tab_footnote(footnote = "N = No; PY = Partial Yes; Y = Yes; CL = Critically Low; L = Low; M = Moderate; H = High") %>% 
  data_color(columns = 2:18,
             fn = scales::col_factor(palette = c("#ab1d1a", "#8ace7e", "#e03531", "#ffda66", "#e03531", "#b2dfa8", "#8ace7e"),
                                         domain = c("CL", "H", "L", "M", "N", "PY", "Y")))
             
          
print(t2_formatted)
```

```{r t2-save}
#save as HTML
#gtsave(t2_formatted, filename = "table_2.html", path = here("outputs", "tables"))

#save as word doc
#gtsave(t2_formatted, filename = "table2_word.docx", path = here("outputs", "tables"))

#export as excel to transfer to word - word output not working on gt table
#rio::export(t2, here("outputs", "tables", "t2_excel.xlsx"))
```

### Table 3. Risk of Bias in Included Systematic Reviews (ROBIS)

```{r t3-robis}
#remove leading numbers, select variables
t3 <- robis_rating_td %>% 
    mutate_if(is.character, ~case_when(. == "HIGH" ~ "High",
                                     . == "LOW" ~ "Low",
                                     . == "UNCLEAR" ~ "Unclear",
                                     TRUE ~ .)) %>% 
  select(review_author_year, ends_with("decision"), robis_overall_a, robis_overall_b, robis_overall_c, robis_overall_rating) %>% 
  arrange(str_to_lower(review_author_year))

#create gt table
t3_formatted <- t3 %>% 
  gt() %>% 
  cols_label(review_author_year = "Review", 
             robis_1_decision = "Domain 1",
             robis_2_decision = "Domain 2",
             robis_3_decision = "Domain 3",
             robis_4_decision = "Domain 4",
             robis_overall_a = "Interpretation",
             robis_overall_b = "Relevance",
             robis_overall_c = "Spin",
             robis_overall_rating = "Overall") %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1))),
            locations = cells_body(columns = everything())) %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1)),
                         cell_text(weight = "bold")),
            locations = cells_column_labels()) %>% 
   tab_options(column_labels.border.top.color = "black",
              column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table.border.top.color = "white",
              heading.border.bottom.color = "black",
              table_body.hlines.color = "white",
              table.border.bottom.color = "white",
              table.font.names = "Times New Roman") %>% 
   cols_width(review_author_year ~ px(165),
              robis_overall_a ~ px(110),
              robis_overall_b ~ px(100),
              robis_overall_c ~ px(100),
              everything() ~ px(100),
              robis_overall_rating ~ px(50)) %>% 
  data_color(columns = 2:9,
             colors = scales::col_factor(palette = c("#e03531", "#8ace7e", "#e03531", "gray60", "#ef9997", "#b2dfa8", "#ffda66", "#8ace7e"),
                                         domain = c("High", "Low", "No", "No Information", "Probably No", "Probably Yes", "Unclear", "Yes")))


print(t3_formatted)

```

```{r t3-save}
#save as html
#gtsave(t3_formatted, filename = "table_3.html", path = here("outputs", "tables"))

#save as word doc
#gtsave(t3_formatted, filename = "table3_word.docx", path = here("outputs", "tables"))

#export as excel to transfer to word - word output not working on gt table
#rio::export(t3, here("outputs", "tables", "t3_excel.xlsx"))

```

### Table 4. Characteristics of Included Primary Studies

```{r t4-info}
#select study level variables for table 4
t4_info <- study_td %>% 
  select(refid, study_author_year, study_country, study_number_participants,
         study_number_classrooms, study_number_schools, study_school_level, 
         study_research_design, study_assignment_level)

#select relevant individual rob data
t4_irob <- irob_td %>% 
  select(refid, irob_overall_decision) %>% 
  rename(overall_rob_rating = irob_overall_decision) 

#select relevant cluster rob data
t4_crob <- crob_td %>% 
  select(refid, crob_overall_judgment) %>% 
  rename(overall_rob_rating = crob_overall_judgment)

#select relevant QED rob data
t4_robins <- robins_td %>% 
  select(refid, robins_overall_judgment) %>% 
  rename(overall_rob_rating = robins_overall_judgment) 

#bind together all rob data for primary studies
t4_allrob <- rbind(t4_irob, t4_crob, t4_robins)

#merge rob info with t4_info and format data for table
t4 <- t4_info %>% 
  left_join(t4_allrob) %>% 
  mutate_at(vars(study_school_level, study_research_design, study_assignment_level, overall_rob_rating), list(~str_remove(., "^[0-9]+\\. "))) %>% 
  mutate(school_level = str_replace(study_school_level, ",(...)(.*)", ",\\2")) %>% 
  mutate(school_level = str_replace(study_school_level, "School", ""),
         design = case_when(study_research_design == "Randomized trial" & study_assignment_level == "Individual" ~ "Individual RCT",
                            study_research_design == "Randomized trial" & study_assignment_level == "Cluster" ~ "Cluster RCT",
                            study_research_design == "QED - Regression adjustment" ~ "QED",
                            TRUE ~ study_research_design)) %>% 
  mutate(school_level = case_when(school_level == "Only reported Secondary " ~ "Secondary",
                                  school_level == "Only reported Primary " ~ "Primary",
                                  school_level == "Only reported Primary , Only reported Secondary School" ~ "Primary , Secondary",
                                  school_level == "Cannot tell" ~ "NR",
                                  TRUE ~ school_level)) %>% 
  mutate(school_level = str_replace(school_level, "(,.)", "and "),
         number_participants = format(study_number_participants, big.mark = ",", scientific = FALSE)) %>% 
  mutate(school_level = str_replace(school_level, "School", ""),
         school_level = str_replace(school_level, " ; ", "; ")) %>%
  mutate_if(is.numeric, as.character) %>% 
  mutate_all(list(~ifelse(is.na(.), "NR", .))) %>% 
  select(refid, study_author_year:school_level, design, overall_rob_rating) %>% 
  select(-study_school_level, -study_research_design, -study_assignment_level)



#create df of study names and refids for merging
study_idbyname <- study_td %>% 
  select(refid, study_author_year)

#select variables needed from group level data
t4_group <- group_td %>% 
  select(refid, group_id, study_group_type, study_group_name, study_group_type,  study_group_comparison_type) %>%
  left_join(study_idbyname) %>% 
  mutate_all(list(~ifelse(. == -999, "Not reported", .))) %>% 
  mutate_at(vars(study_group_type, study_group_comparison_type), list(~str_remove(., "^[0-9]+\\. "))) %>% 
  select(refid, study_author_year, everything()) %>% 
  arrange(study_author_year) 

# #transform intervention names data to merge
# t4group_intnames <- t4_group %>% 
#   group_by(study_author_year, study_group_type) %>% 
#   summarize(group_names = paste(study_group_name, collapse = "; ")) %>% 
#   ungroup() %>% 
#   filter(study_group_type == "Intervention")
# 
# #transform comparison types data to merge
# t4group_compnames <- t4_group %>% 
#   mutate(comparison_type = case_when(comparison_type == "Active" ~ paste("Active:", gname),
#                                      TRUE ~ comparison_type)) %>% 
#   group_by(study_author_year, group_type) %>% 
#   summarize(comp_type = paste(comparison_type, collapse = "; ")) %>% 
#   ungroup() %>% 
#   filter(group_type == "Comparison")

#merge group names and transform to wide format
t4group_wide <- t4_group %>% 
  group_by(refid, study_group_type) %>% 
  summarize(study_group_name = paste(study_group_name, collapse="; and "),
            .groups = "drop") %>% 
  pivot_wider(id_cols = refid,
              names_from = study_group_type,
              values_from = study_group_name) %>% 
  mutate_all(~ str_replace_all(., "Cannot tell", "NR"))

#merge group level with study level data
t4_full <- left_join(t4, t4group_wide) %>% 
  select(study_author_year:school_level, Intervention, Comparison, design, overall_rob_rating) %>% 
  arrange(str_to_lower(stringi::stri_trans_general(study_author_year, "Latin-ASCII")))

```

```{r t4}

#create gt table 
t4_formatted <- t4_full %>% 
  gt() %>% 
  cols_label(study_author_year = "Study", 
             study_country = "Country",
             study_number_participants = "Students",
             study_number_classrooms = "Classrooms",
             study_number_schools = "Schools",
             school_level = "Level",
             design = "Design",
             overall_rob_rating = "Risk of Bias") %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1))),
            locations = cells_body(columns = everything())) %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1)),
                         cell_text(weight = "bold")),
            locations = cells_column_labels()) %>% 
  tab_options(column_labels.border.top.color = "black",
              column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table.border.top.color = "white",
              heading.border.bottom.color = "black",
              table_body.hlines.color = "white",
              table.border.bottom.color = "white",
              table.font.names = "Times New Roman") %>% 
  tab_style(style = cell_text(align = "left"), locations = cells_body(columns = "study_number_participants")) %>% 
  tab_footnote(footnote = md("**NR = Not reported; TAU: Treatment as usual; RCT = Randomized controlled trial; QED = Quasi-experimental design**"))

print(t4_formatted)

```

```{r t4-save}
#save as html
#gtsave(t4_formatted, filename = "table_4.html", path = here("outputs", "tables"))

#save as word doc
#gtsave(t4_formatted, filename = "table4_word.docx", path = here("outputs", "tables"))

#export as excel to transfer to word - word output not working on gt table
#rio::export(t4_full, here("outputs", "tables", "t4_excel.xlsx"))

```

### Appendices

#### Appendix 1. List of excluded reviews

```{r a1-excludedreviews}
#import citation info 
review_elig_citations <- import(here("data", "APO_review_eligibility_citations.xlsx"))

#create df of excluded reviews and citations
a1_info <- review_elig_citations %>% 
  filter(review_eligibility_decision == "Not Eligible") %>% 
  left_join(review_elig_df, by = "Refid") %>% 
  filter(review_exclude_reason != "Unclear (unable to retrieve)") %>% 
  rename(citation = Bibliography.x) %>% 
  select(citation, review_exclude_reason) %>% 
  arrange(str_to_lower(stringi::stri_trans_general(citation, "Latin-ASCII")))

#create table
a1_formatted <- a1_info %>% 
  gt()  %>% 
  cols_label(citation = "Excluded Review", 
             review_exclude_reason = "Reason for Exclusion") %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1))),
            locations = cells_body(columns = everything())) %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1)),
                         cell_text(weight = "bold")),
            locations = cells_column_labels()) %>% 
  tab_options(column_labels.border.top.color = "black",
              column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table.border.top.color = "white",
              heading.border.bottom.color = "black",
              table_body.hlines.color = "white",
              table.border.bottom.color = "white",
              table.font.names = "Times New Roman")

print(a1_formatted)

```

```{r a1-save}
#save as word
#gtsave(a1_formatted, filename = "appendix1_word.docx", path = here("outputs", "appendices"))

#save as html
#gtsave(a1_formatted, filename = "appendix_1.html", path = here("outputs", "appendices"))

#save as pdf
#gtsave(a1_formatted, filename = "appendix1_pdf.pdf")

#export as excel to transfer to word - word output not working on gt table
#rio::export(a1_info, here("outputs", "appendices", "a1_excel.xlsx"))
```


#### Appendix 2. List of excluded primary studies

```{r a2-excludedstudies}
#import citation info 
study_elig_citations <- import(here("data", "APO_study_eligibility_citations.xlsx")) %>% 
  janitor::clean_names()

#create df of excluded reviews and citations
a2_info <- study_elig_citations %>% 
  filter(study_eligibility_decision == "Not Eligible") %>% 
  left_join(study_elig_df, by = "refid") %>% 
  filter(study_exclude_reason != "Unclear (contact author)") %>% 
  rename(citation = bibliography.x) %>% 
  select(citation, study_exclude_reason) %>% 
  arrange(str_to_lower(stringi::stri_trans_general(citation, "Latin-ASCII")))

#create table
a2_formatted <- a2_info %>% 
  gt()  %>% 
  cols_label(citation = "Excluded Study", 
             study_exclude_reason = "Reason for Exclusion") %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1))),
            locations = cells_body(columns = everything())) %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1)),
                         cell_text(weight = "bold")),
            locations = cells_column_labels()) %>% 
  tab_options(column_labels.border.top.color = "black",
              column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table.border.top.color = "white",
              heading.border.bottom.color = "black",
              table_body.hlines.color = "white",
              table.border.bottom.color = "white",
              table.font.names = "Times New Roman")

print(a2_formatted)
```

```{r a2-save}
#save as word
#gtsave(a2_formatted, filename = "appendix2_word.docx", path = here("outputs", "appendices"))

#save as html
#gtsave(a2_formatted, filename = "appendix_2.html", path = here("outputs", "appendices"))

#save as pdf
#gtsave(a2_formatted, filename = "appendix2_pdf.pdf")

#export as excel to transfer to word - word output not working on gt table
#rio::export(a2_info, here("outputs", "appendices", "a2_excel.xlsx"))
```


#### Appendix 3. Primary studies awaiting classification 

```{r a3-awaitingclassification}
#create df with studies awaiting classification
a3_info <- study_elig_citations %>% 
  left_join(study_elig_df, by = "refid") %>% 
  filter(study_exclude_reason == "Unclear (contact author)") %>% 
  mutate(study_eligibility_notes = str_remove_all(study_eligibility_notes, "\\(.*?\\)")) %>% 
  rename(citation = bibliography.x) %>% 
  select(citation, study_eligibility_notes) %>% 
  arrange(str_to_lower(stringi::stri_trans_general(citation, "Latin-ASCII")))

#create formatted gt table
a3_formatted <- a3_info %>% 
  gt()  %>% 
  cols_label(citation = "Study", 
             study_eligibility_notes = "Reason") %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1))),
            locations = cells_body(columns = everything())) %>% 
  tab_style(style = list(cell_borders(sides = "all", color = "black", weight = px(1)),
                         cell_text(weight = "bold")),
            locations = cells_column_labels()) %>% 
  tab_options(column_labels.border.top.color = "black",
              column_labels.border.bottom.color = "black",
              table_body.border.bottom.color = "black",
              table.border.top.color = "white",
              heading.border.bottom.color = "black",
              table_body.hlines.color = "white",
              table.border.bottom.color = "white",
              table.font.names = "Times New Roman")

print(a3_formatted)


```

```{r a3-save}
# #save as word
# gtsave(a3_formatted, filename = "appendix3_word.docx", path = here("outputs", "appendices"))

#save as html
#gtsave(a3_formatted, filename = "appendix_3.html", path = here("outputs", "appendices"))

# #save as html
# gtsave(a3_formatted, filename = "appendix3_pdf.pdf")

#export as excel to transfer to word - word output not working on gt table
#rio::export(a3_info, here("outputs", "appendices", "a3_excel.xlsx"))
```

#### Appendix 4. Descriptive characteristics for each included systematic review

```{r a4-reviewchar}
#select relevant appendix 4 info
a4_info <- review_td %>% 
  left_join(numelig_perreview) %>% 
  left_join(numinc_perreview) %>% 
  mutate(search_date_format = ifelse(nchar(review_search_date) == 10, format(ymd(review_search_date), "%B %d, %Y"), review_search_date)) %>% 
  mutate(search_date_format = ifelse(nchar(review_search_date) == 7, format(ym(review_search_date), "%B %Y"), search_date_format)) %>% 
  mutate(across(everything(), ~ifelse(.x == -999, "Not reported", .x)),
         n_included = as.character(n_included),
         n_eligible = as.character(n_eligible)) %>% 
  select(refid, review_author_year, starts_with("review_eligibility"), review_databases_searched, 
         search_date_format, n_included, n_eligible, review_flow_diagram, review_registration_number, review_availability_statement) %>% 
  arrange(str_to_lower(review_author_year)) 

#create df of review_author_year and refid for merging
review_idbyname <- review_td %>% 
  select(refid, review_author_year)

#select citation info for eligible reviews
review_citations <- review_elig_citations %>% 
  janitor::clean_names() %>% 
  left_join(review_idbyname) %>% 
  filter(!is.na(review_author_year)) %>% 
  rename(citation = bibliography)

#import linked citations for all references
linked_ref_df <- import(here("data", "APO_linked_references.csv")) %>% 
  janitor::clean_names()

#pull list of included refids
inc_rev <- review_citations$refid

#transform for merging
linked_ref_td <- linked_ref_df %>% 
  filter(refid %in% inc_rev) %>% 
  select(refid, linked_refid) %>% 
  left_join(review_citations) %>% 
  left_join(review_elig_citations, by = c("linked_refid" = "Refid")) %>% 
  rename(main_citation = citation,
         linked_citation = Bibliography) %>%
  select(refid, main_citation, starts_with("linked")) %>% 
  pivot_longer(cols = c(main_citation, linked_citation),
               names_to = "citation_type",
               values_to = "citation",
               values_drop_na = TRUE) %>% 
  mutate(citation_refid = case_when(citation_type == "main_citation" ~ as.character(refid),
                                    citation_type == "linked_citation" ~ as.character(linked_refid))) %>%
  select(-c(linked_refid, citation_type)) %>% 
  filter(refid != citation_refid)

#create variable that combines all references for a review into one cell
review_reports <- review_citations %>% 
  select(refid, citation) %>% 
  mutate(citation_refid = "") %>% 
  rbind(linked_ref_td) %>% 
  group_by(refid) %>% 
  summarize(all_reports = paste(citation, collapse = " <br><br> ")) %>% 
  mutate(all_reports = stringi::stri_trans_general(all_reports, "Latin-ASCII")) %>% 
  ungroup()


#extract titles from citation df
rev_titles <- review_citations %>% 
  select(refid, title)

#merge titles and citations with other a4 info and format eligibility cells
a4 <- a4_info %>% 
  left_join(rev_titles, by = "refid") %>% 
  left_join(review_reports, by = "refid") %>% 
  select(review_author_year, title, review_eligibility_participant:review_availability_statement, all_reports) %>% 
#cosmetics for table
  mutate_at(vars(starts_with("review_eligibility"), review_availability_statement), list(~ str_replace_all(., "\\s+-\\s+(?=[A-Z])", "<br> - "))) %>% 
  mutate_at(vars(starts_with("review_eligibility"), review_availability_statement), ~ str_replace_all(., "- +([\"'a-zA-Z])", " <li>\\1")) %>% 
  mutate_at(vars(starts_with("review_eligibility")), ~ paste0("<ul>", ., "</ul>")) %>% 
  mutate(review_availability_statement = ifelse(str_detect(review_availability_statement, "<li>"),
                                                paste0("<ul>", review_availability_statement, "</ul>"),
                                                review_availability_statement))

```


```{r a4-formatting}
#split data frame into list of data frames
a4_dflist <- map(1:nrow(a4), ~a4[.x, ])

#transfer to long format
df_list_long <- map(a4_dflist, ~ .x %>% 
                      pivot_longer(cols = everything(), 
                                   names_to = "variable", 
                                   values_to = "value") %>% 
                      mutate(variable = case_when(variable == "review_author_year" ~ "Review",
                                                  variable == "title" ~ "Title",
                                                  variable == "review_eligibility_participant" ~ "Participants",
                                                  variable == "review_eligibility_intervention" ~ "Interventions",
                                                  variable == "review_eligibility_comparator" ~ "Comparisons",
                                                  variable == "review_eligibility_outcome" ~ "Outcomes",
                                                  variable == "review_eligibility_timing" ~ "Timing",
                                                  variable == "review_eligibility_setting" ~ "Setting",
                                                  variable == "review_eligibility_design" ~ "Design",
                                                  variable == "review_databases_searched" ~ "Databases Searched",
                                                  variable == "search_date_format" ~ "Search Date",
                                                  variable == "review_flow_diagram" ~ "Prisma Diagram", 
                                                  variable == "review_registration_number" ~ "Registration",
                                                  variable == "review_availability_statement" ~ "Data Availability Statement",
                                                  variable == "n_eligible" ~ "Eligible Studies",
                                                  variable == "n_included" ~ "Included Studies",
                                                  variable == "all_reports" ~ "References",
                                                  TRUE ~ variable)))
  
#combine into one single data frame
combined_a4 <- bind_rows(df_list_long, .id = "source") %>% 
  mutate(source = as.numeric(source))

#create gt table for each for each review
list_gt <- lapply(split(combined_a4, combined_a4$source), function(x) {
  gt(x) %>% 
    cols_hide("source") %>% 
    cols_label(variable = "",
               value = "") %>% 
    tab_style(style = list(cell_text(weight = "bold")),
            locations = cells_body(columns = "variable")) %>% 
    tab_row_group(rows = 3:9, label = "Eligibility Criteria:") %>% 
    tab_row_group(rows = 1:2, label = "", id = "group1") %>% 
    tab_options(table.font.names = "Times New Roman",
                table.width = pct(100)) %>% 
    tab_style(style = cell_text(weight = "bold"), locations = cells_row_groups()) %>% 
    tab_style(style = cell_text(align = "right"), locations = cells_body(columns = "variable", rows = 3:9)) %>%
    fmt_markdown()
})

#extract HTML code of table
html_code <- list_gt %>% 
  map(as_raw_html) %>% 
  reduce(paste)

#print in document
htmltools::HTML(html_code)
```

```{r a4-save}
#save as HMTL
writeLines(html_code, here("outputs", "appendices", "appendix_4.html"))

#test word output
#couldnt get to work - output to excel and import into word
#rio::export(combined_a4, here("outputs", "appendices", "a4_excel.xlsx"))


```

#### Appendix 5. Characteristics of Included Primary Studies

```{r a5-studychar}
#select data for table
a5_info <- study_td %>% 
  
  select(refid, study_author_year, study_start_date, study_end_date, #recruitment_approach, 
         study_eligibility_criteria, study_research_design, study_assignment_level, 
         study_cluster_level, study_cluster_size, study_number_groups,
         starts_with("study_percent"), starts_with("study_number"), study_grade_level, study_age_average, study_age_dispersion,
         study_country, study_state, study_school_area, study_school_level, study_flow_diagram, study_registration, study_availability_statement, study_age_dispersion_type, study_age_avg_type) %>% 
  
  mutate(study_school_level = str_remove_all(study_school_level, "Only reported"),
         study_school_level = str_replace(study_school_level, "  ", " "),
         study_school_level = str_trim(study_school_level, side = "left"),
         across(where(is.character), ~ str_replace(., "Cannot tell", "Not reported")),
         study_research_design = ifelse(study_research_design == "QED - Regression adjustment", "Quasi-experimental design", study_research_design)) %>% 
  
  mutate(study_start_date = ifelse(nchar(study_start_date) == 10, format(ymd(study_start_date), "%B %d, %Y"), study_start_date),
         study_end_date = ifelse(nchar(study_end_date) == 10, format(ymd(study_end_date), "%B %d, %Y"), study_end_date)) %>% 
  mutate(study_start_date = ifelse(nchar(study_start_date) == 7, format(ym(study_start_date), "%B %Y"), study_start_date),
         study_end_date = ifelse(nchar(study_end_date) == 7, format(ym(study_end_date), "%B %Y"), study_end_date)) %>% 
  mutate(study_number_participants = format(study_number_participants, big.mark = ",", scientific = FALSE),
         sample_size = case_when(!is.na(study_number_participants) & !is.na(study_number_classrooms) & !is.na(study_number_schools) ~
                                   paste(study_number_participants, "students;", study_number_classrooms, "classrooms;", study_number_schools, "schools"),
                                 !is.na(study_number_participants) & !is.na(study_number_classrooms) & is.na(study_number_schools) ~
                                   paste(study_number_participants, "students;", study_number_classrooms, "classrooms"),
                                 !is.na(study_number_participants) & is.na(study_number_classrooms) & is.na(study_number_schools) ~
                                   paste(study_number_participants, "students"),
                                 !is.na(study_number_participants) & is.na(study_number_classrooms) & !is.na(study_number_schools) ~
                                   paste(study_number_participants, "students;", study_number_schools, "schools"),
                                 is.na(study_number_participants) & !is.na(study_number_classrooms) & !is.na(study_number_schools) ~
                                   paste(study_number_classrooms, "classrooms;", study_number_schools, "schools"),
                                 is.na(study_number_participants) & !is.na(study_number_classrooms) & is.na(study_number_schools) ~
                                   paste(study_number_classrooms, "classrooms"),
                                 is.na(study_number_participants) & is.na(study_number_classrooms) & !is.na(study_number_schools) ~
                                   paste(study_number_schools, "schools")),
         sample_size = str_trim(sample_size, side = "left"),
         grd_schl_level = paste(study_grade_level, "/", study_school_level),
         age_mean_sd = case_when(study_age_avg_type == "Mean" & study_age_dispersion_type == "Standard deviation" ~ 
                                   paste0("Mean = ", study_age_average, " (SD = ", study_age_dispersion, ")"),
                                 study_age_avg_type == "Mean" & study_age_dispersion_type == "Range" ~ 
                                   paste0("Mean = ", study_age_average, " (Range = ", study_age_dispersion, ")"),
                                 study_age_avg_type == "Median" & study_age_dispersion_type == "Range" ~ 
                                   paste0("Median = ", study_age_average, " (Range = ", study_age_dispersion, ")"),
                                 study_age_avg_type == "Not reported" & study_age_dispersion_type == "Range" ~
                                   paste0("Range = ", study_age_dispersion),                                 ),
         study_percent_female = ifelse(!is.na(study_percent_female), paste0(study_percent_female * 100, "%"), "Not reported"),
         study_percent_ell = ifelse(!is.na(study_percent_ell), paste0(study_percent_ell * 100, "%"), "Not reported"),
         study_percent_frpl = ifelse(!is.na(study_percent_frpl), paste0(study_percent_frpl * 100, "%"), "Not reported"),
         percent_race_ethnicity = case_when(is.na(study_percent_white) & is.na(study_percent_black) & is.na(study_percent_aian) &
                                            is.na(study_percent_asian) & is.na(study_percent_nhpi) & is.na(study_percent_hispanic) & 
                                            is.na(study_percent_mixed) & is.na(study_percent_other) ~ "Not reported",
                                            TRUE ~ paste0(study_percent_aian * 100, "% AIAN, ", study_percent_asian * 100, "% Asian, ",
                                                          study_percent_black * 100, "% Black, ", study_percent_hispanic * 100, "% Latinx, ",
                                                          study_percent_nhpi * 100, "% NHPI, ", study_percent_white * 100, "% White, ", 
                                                          study_percent_mixed * 100, "% Mixed, ", study_percent_other * 100, "% Other")),
         country_state = case_when(study_state != "" ~ paste0(study_country, " (", study_state, ")"),
                                   TRUE ~ study_country)) %>%
  mutate(age_mean_sd = case_when(age_mean_sd == "NA (-999)" ~ "Not reported",
                                 str_detect(age_mean_sd, "-999") ~ paste(study_age_average),
                                 TRUE ~ age_mean_sd),
         percent_race_ethnicity = str_replace_all(percent_race_ethnicity, c("NA% AIAN, " = "", "NA% Asian, " = "", "NA% Black, " = "",
                                                                            "NA% Latinx, " = "", "NA% NHPI, " = "", "NA% White, " = "",
                                                                            "NA% Mixed, " = "", "NA% Other" = ""))) %>% 
  mutate(percent_race_ethnicity = gsub(", $", "", percent_race_ethnicity)) %>% 
  mutate(across(everything(), ~ifelse(.x == -999 | .x == "Cannot tell" | .x == "Cannot Tell" | is.na(.x), "Not reported", .x)),
         across(c(study_cluster_level, study_cluster_size), ~ifelse(study_assignment_level != "Cluster", "NA", .x))) %>%
  select(refid, study_author_year, study_start_date, study_end_date,
         study_eligibility_criteria, study_research_design, study_assignment_level, 
         study_cluster_level, study_cluster_size, study_number_groups,
         sample_size, grd_schl_level, age_mean_sd, study_percent_female, 
         percent_race_ethnicity, study_percent_ell, study_percent_frpl,
         country_state, study_school_area, study_school_level, study_flow_diagram, 
         study_registration, study_availability_statement)

#merge with group/intervention names created for table 4
a5_groups <- t4group_wide %>% 
  mutate(refid = as.numeric(refid)) %>% 
  right_join(a5_info)

#merge with outcome data and combine outcomes for each study
a5_outcome <- outcome_td %>% 
  distinct(refid, study_outcome_domain, .keep_all = TRUE) %>% 
  group_by(refid) %>% 
  summarize(outcome_list = paste(study_outcome_domain, collapse = "; ")) %>% 
  ungroup() %>% 
  mutate(outcome_list = sapply(lapply(str_split(outcome_list, "; "), sort), paste, collapse = "; ")) %>% 
  select(refid, outcome_list) %>% 
  right_join(a5_groups)

#merge with rob data created in table 4
a5_rob <- t4_allrob %>% 
  right_join(a5_outcome) #%>% 
  # select(study_author_year, study_start_date, study_end_date, 
  #        study_eligibility_criteria, research_design, assignment_level, cluster_type, cluster_size, study_groups,
  #        sample_size, grd_schl_level, age_mean_sd, percent_female, percent_race_ethnicity, percent_ELL, percent_FRPL,
  #        country_state, urbanicity, school_type, Intervention, Comparison, outcome_list, overall_rob_rating,
  #        consort_flow_diagram, study_registration, availability_statement)

#LINKED REFS
#import all citations
all_citations_df <- import(here("data", "APO_all_citations.csv")) %>% 
  janitor::clean_names()

#merge linked reference df and transform for merging
linked_study_td <- linked_ref_df %>% 
  filter(refid %in% inc_ps_wlinked) %>% 
  select(refid, linked_refid) %>% 
  left_join(study_elig_citations) %>% 
  left_join(all_citations_df, by = c("linked_refid" = "refid")) %>% 
  rename(main_citation = bibliography.x,
         linked_citation = bibliography.y) %>%
  select(refid, main_citation, starts_with("linked")) %>% 
  pivot_longer(cols = c(main_citation, linked_citation),
               names_to = "citation_type",
               values_to = "citation",
               values_drop_na = TRUE) %>% 
  mutate(citation_refid = case_when(citation_type == "main_citation" ~ as.character(refid),
                                    citation_type == "linked_citation" ~ as.character(linked_refid))) %>%
  select(-c(linked_refid, citation_type)) %>% 
  filter(refid != citation_refid)

#create variable that combines all references for a review into one cell
study_reports <- study_elig_citations %>% 
  filter(refid %in% inc_ps_wlinked) %>% 
  select(refid, bibliography) %>% 
  rename(citation = bibliography) %>% 
  mutate(citation_refid = "") %>% 
  rbind(linked_study_td) %>% 
  filter(citation_refid != 10487) %>% 
  group_by(refid) %>% 
  summarize(all_reports = paste(citation, collapse = " <br><br> ")) %>% 
  mutate(all_reports = stringi::stri_trans_general(all_reports, "Latin-ASCII")) %>% 
  ungroup()


#extract titles from citation df
study_titles <- study_elig_citations %>% 
  select(refid, title)

#merge together
a5 <- a5_rob %>% 
  left_join(study_reports) %>% 
  left_join(study_titles) %>% 
  mutate(study_eligibility_criteria = str_replace(study_eligibility_criteria, ". Exclude:", ". <br> Exclude:")) %>% 
  select(study_author_year, title, study_start_date, study_end_date,
         study_eligibility_criteria, study_research_design, study_assignment_level, study_cluster_level, 
         study_cluster_size, study_number_groups,
         sample_size, grd_schl_level, age_mean_sd, study_percent_female, percent_race_ethnicity, 
         study_percent_ell, study_percent_frpl,
         country_state, study_school_area, study_school_level, Intervention, Comparison, outcome_list, overall_rob_rating,
         study_flow_diagram, study_registration, study_availability_statement, all_reports) %>% 
  mutate_if(is.numeric, as.character) %>% 
  arrange(str_to_lower(stringi::stri_trans_general(study_author_year, "Latin-ASCII")))



```


```{r a5-format}
#transfer dataframe into list per df
a5_dflist <- map(1:nrow(a5), ~a5[.x, ])

##transfer to long format
a5_long <- map(a5_dflist, ~ .x %>% 
                      pivot_longer(cols = everything(), 
                                   names_to = "variable", 
                                   values_to = "value") %>% 
                      mutate(variable = case_when(variable == "study_author_year" ~ "Study", 
                                                  variable == "title" ~ "Title",
                                                  variable == "study_start_date" ~ "Start Date",
                                                  variable == "study_end_date" ~ "End Date",
                                                  variable == "study_eligibility_criteria" ~ "Eligibility Criteria",
                                                  variable == "study_research_design" ~ "Research Design",
                                                  variable == "study_assignment_level" ~ "Assignment Level",
                                                  variable == "study_cluster_level" ~ "Cluster Type",
                                                  variable == "study_cluster_size" ~ "Average Cluster Size",
                                                  variable == "study_number_groups" ~ "Trial Arms",
                                                  variable == "sample_size" ~ "Sample Size",
                                                  variable == "grd_schl_level" ~ "Grade/School Level",
                                                  variable == "age_mean_sd" ~ "Age",
                                                  variable == "study_percent_female" ~ "Percent Female",
                                                  variable == "percent_race_ethnicity" ~ "Percent Race/Ethnicity",
                                                  variable == "study_percent_ell" ~ "Percent ELL",
                                                  variable == "study_percent_frpl" ~ "Percent FRPL",
                                                  variable == "country_state" ~ "Country (State)",
                                                  variable == "study_school_area" ~ "Geographic Area",
                                                  variable == "study_school_level" ~ "School Type",
                                                  variable == "Intervention" ~ "Active Intervention",
                                                  variable == "Comparison" ~ "Comparison Group",
                                                  variable == "outcome_list" ~ "Outcomes",
                                                  variable == "overall_rob_rating" ~ "Risk of Bias",
                                                  variable == "study_flow_diagram" ~ "Flow Diagram",
                                                  variable == "study_registration" ~ "Registration", 
                                                  variable == "study_availability_statement" ~ "Data/Code Availability",
                                                  variable == "all_reports" ~ "References",
                                                  TRUE ~ variable)))

#combine into one single dataframe
combined_a5 <- bind_rows(a5_long, .id = "source") %>% 
  mutate(source = as.numeric(source))

```

```{r a5-gtlist}
a5_list_gt <- lapply(split(combined_a5, combined_a5$source), function(x) {
  gt(x) %>%
    cols_hide("source") %>%
    cols_label(variable = "",
               value = "") %>%
    cols_width(variable ~ px(175)) %>%
    tab_style(style = list(cell_text(weight = "bold")),
            locations = cells_body(columns = "variable")) %>%
    tab_style(style = list(css("text-indent" = "10px")),
            locations = cells_body(columns = "variable",
                                  rows = c(9, 10))) %>%
    tab_options(table.font.names = "Times New Roman",
                table.width = pct(100)) %>%
    fmt_markdown() #rows = nrow(x)
})


#extract HTML table
html_code_a5 <- a5_list_gt %>% 
  map(as_raw_html) %>% 
  reduce(paste)

#print in document
htmltools::HTML(html_code_a5)

```

```{r a5-save}
#save as HMTL
writeLines(html_code_a5, here("outputs", "appendices", "appendix_5.html"))

#couldnt get to work - output to excel and import into word
#rio::export(combined_a5, here("outputs", "appendices", "a5_excel.xlsx"))

```


# Info for Translational Product

Information for initial translational product (to fill out comms team excel file)

```{r translational-results}
#study locations
count_country

#academic levels
#number/% studies in elementary or primary school
study_elem 
study_elem_per 

sum(!is.na(study_td$study_school_level_elementary_school)) + 
sum(!is.na(study_td$study_school_level_only_reported_primary_school))

#number/% studies in middle school
study_mid 
study_mid_per

#number/% studies in high or secondary school
study_high 
study_high_per 

sum(!is.na(study_td$study_school_level_high_school)) + 
sum(!is.na(study_td$study_school_level_only_reported_secondary_school))

#included studies
length(unique(study_td$refid))

#number of students
num_studs

#median age and range
min(study_td$study_age_average, na.rm = TRUE) 
max(study_td$study_age_average, na.rm = TRUE)
median(study_td$study_age_average, na.rm = TRUE)

#number of studies not reporting any race/ethnicity
race_cols <- c("study_percent_aian", "study_percent_asian", "study_percent_black", "study_percent_nhpi",
               "study_percent_white", "study_percent_hispanic", "study_percent_mixed", "study_percent_other")
num_raceNR <- sum(rowSums(is.na(study_td[race_cols])) == length(race_cols))
per_raceNR <- paste0(round(num_raceNR / length(unique(study_td$refid)) * 100, 2), "% of studies didn't report race/ethnicity")
per_raceNR

#average (or median) and SD of % white students
format_percent(median(study_td$study_percent_white, na.rm = TRUE) * 100, 2)
format_percent(mean(study_td$study_percent_white, na.rm = TRUE) * 100, 2)
format_percent(sd(study_td$study_percent_white, na.rm = TRUE) * 100, 2)
#DIFFERENCE IN MEDIAN AND MEAN DRIVEN BY 100% OF CANADIAN STUDY SAYING "OTHER RACE"

#median number of students per study and range
median(study_td$study_number_participants, na.rm = TRUE)
min(study_td$study_number_participants, na.rm = TRUE)
format_thousands(max(study_td$study_number_participants, na.rm= TRUE))

#total, and median/range of number of classrooms per study
sum(study_td$study_number_classrooms, na.rm = TRUE)
median(study_td$study_number_classrooms, na.rm = TRUE)
min(study_td$study_number_classrooms, na.rm = TRUE)
max(study_td$study_number_classrooms, na.rm = TRUE)

#total, and median/range of number of schools per study
sum(study_td$study_number_schools, na.rm = TRUE)
median(study_td$study_number_schools, na.rm = TRUE)
min(study_td$study_number_schools, na.rm = TRUE)
max(study_td$study_number_schools, na.rm = TRUE)

#number and percentage of facilitators/providers
count_intprovider 

#number of students per MA outcome
## Anxiety Diagnoses
ad_ma_df <- import(here("data", "Anxiety_diagnosis.xlsx"))
ad_refid <- unique(ad_ma_df$refid) #8
ad_num_stud <- study_td %>% 
  filter(refid %in% ad_refid) %>% 
  summarize(n_stud = sum(study_number_participants)) %>% 
  pull(n_stud)
ad_num_stud

## Anxiety Symptoms
as_ma_df <- import(here("data", "Anxiety_Symptoms.xlsx"))
as_refid <- unique(as_ma_df$refid) #32
as_num_stud <- study_td %>% 
  filter(refid %in% as_refid) %>% 
  filter(refid != 10062) %>% #removed from analysis - MSC
  summarize(n_stud = sum(study_number_participants)) %>% 
  pull(n_stud)
as_num_stud

## Depression Symptoms
ds_ma_df <- import(here("data", "Depression_Symptoms.xlsx"))
ds_refid <- unique(ds_ma_df$refid) #18
ds_num_stud <- study_td %>% 
  filter(refid %in% ds_refid) %>% 
  filter(refid != 10062) %>%  #removed from analysis - MSC
  summarize(n_stud = sum(study_number_participants)) %>% 
  pull(n_stud)
ds_num_stud

```



## END